<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Index</title>
  </head>
  <body>
    <label for="session1">Session 1 Attendance</label>
    <input type="radio" name="currentSession" id="session1" value="1">
    <label for="session2">Session 2 Attendance</label>
    <input type="radio" name="currentSession" id="session2" value="2">

    <form action="/" method="POST" id="source-form">
      <label for="source-file">Source File</label>
      <input type="file" id="source-file">
      <input type="submit" name="load" id="load" value="Load Source File">
    </form>
    <div id="reader" width="60vw"></div>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script>
      const sessionSet = {
        1: 'Why A.I. ethics? Why now?',
        2: 'Letâ€™s create our future.'
      }
      let form = document.querySelector('#source-form')

      function onScanSuccess(decodedText, decodedResult) {
        console.log('YES')
        let item = JSON.parse(localStorage.getItem(decodedText))
        if (item) {
          const currentSession = document.querySelector('[name="currentSession"]:checked').value
          if (currentSession && item.hasOwnProperty(`has_attended_${currentSession}`)) {
            item[`has_attended_${currentSession}`] = true
            if(confirm(`Confirm attendance of ${decodedText} to ${sessionSet[currentSession]}`)) {
              localStorage.setItem(decodedText, JSON.stringify(item))
            }
          } else {
            alert('You are not in the registration list')
          }
        } else {
          alert('You are not in the registration list')
        }
      }

      function getEvents(key) {
        if(key == 1) {
          return { has_attended_1: false }
        } else if(key == 2) {
          return { has_attended_2: false }
        } else {
          return {
            has_attended_1: false,
            has_attended_2: false
          }
        }
      }

      let html5QrcodeScanner = new Html5QrcodeScanner("reader", {
        fps: 10,
        qrbox: {
          width: 500, height: 250
        }
      }, false);
      html5QrcodeScanner.render(onScanSuccess, onScanFailure);

      form.addEventListener('submit', evt => {
        evt.preventDefault()
        const csv = evt.currentTarget.querySelector('#source-file').files[0]
        const reader = new FileReader()
        reader.addEventListener('load', readEvent => {
          localStorage.setItem('has_data', 'true')
          const result = readEvent.target.result
          for(let row of result.split('\n')) {
            const key = row.split(',')[0]
            const values = getEvents(row.split(',')[1])
            localStorage.setItem(key, JSON.stringify(values))
          }
          alert('Data has been loaded')
        })
        reader.readAsText(csv);
      })

      window.onload = function() {
        if(localStorage.getItem('has_data')) {
          form.setAttribute('style', 'display: none')
        }
      }
    </script>
  </body>
</html>
